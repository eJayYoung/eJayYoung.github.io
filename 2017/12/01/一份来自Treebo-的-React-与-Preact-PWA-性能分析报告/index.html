<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="stay hungry, stay foolish"><title>一份来自Treebo 的 React 与 Preact PWA 性能分析报告 | 雪庐</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">一份来自Treebo 的 React 与 Preact PWA 性能分析报告</h1><a id="logo" href="/.">雪庐</a><p class="description">逸杰的博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">一份来自Treebo 的 React 与 Preact PWA 性能分析报告</h1><div class="post-meta">Dec 1, 2017<span> | </span><span class="category"><a href="/categories/翻译/">翻译</a></span></div><div class="post-content"><p>React的License事件闹的沸沸扬扬，最终以facebook修改协议的妥协收场。<br>不过那时候的第一备选方案Preact，在PWA的应用中又有怎样的优势呢<br><a id="more"></a></p>
<p><strong>作者</strong>：来自Treebo的<a href="https://twitter.com/__lakshya" target="_blank" rel="external"><em>Lakshya Ranganath</em></a>，和来自Chrome的<a href="https://twitter.com/addyosmani" target="_blank" rel="external"><em>Addy Osmani</em></a></p>
<p><img src="http://p0.qhimg.com/t01aaba6888570ae1c8.png" alt=""></p>
<p><a href="https://treebo.com" target="_blank" rel="external">Treebo</a>是一家印度家喻户晓的经济型连锁酒店，在旅游业中占据了价值200亿美元的市场。他们<a href="https://www.treebo.com/blog/google-io-2017-features-treebos-progressive-web-app/" target="_blank" rel="external">最近</a>开发了一个新的渐进式应用(PWA)作为默认的移动端体验，最开始使用<a href="http://reactjs.com" target="_blank" rel="external">React</a>,但最后在生产环境转向了<a href="http://preactjs.com" target="_blank" rel="external">Preact</a>。</p>
<p>对比之前的移动端可以看到，新版本<strong>在首屏渲染时间上提升了 70%，<a href="https://github.com/WPO-Foundation/webpagetest/blob/master/docs/Metrics/TimeToInteractive.md" target="_blank" rel="external">初始交互时间</a>减少了 31%</strong>。大部分用户在3G环境下使用自己的移动设备只需不到4s即可浏览完整内容。使用WebPageTest模拟印度超慢的3G网络也只需要不到5s。</p>
<p><img src="http://p0.qhimg.com/t010cc631c8729fef79.png" alt=""></p>
<p><strong>从React迁移到Preact也使初始交互时间缩短了15%</strong>。你可以打开<a href="https://treebo.com" target="_blank" rel="external">Treebo.com</a>完整体验一下，但是今天我们想深入探讨分析这个PWA的过程中的一些技术实现。</p>
<p><img src="http://p0.qhimg.com/t018f4b5d234cfdafbb.png" alt=""></p>
<p>这就是Treebo 新版的PWA</p>
<h2 id="1-性能优化之旅"><a href="#1-性能优化之旅" class="headerlink" title="1. 性能优化之旅"></a>1. 性能优化之旅</h2><h3 id="1-1-老版移动端"><a href="#1-1-老版移动端" class="headerlink" title="1.1 老版移动端"></a>1.1 老版移动端</h3><p>老版的Treebo移动端是基于Django框架搭建的。用户在跳转页面时必须等待服务端请求。这个版本的首屏渲染时间为1.5s，首屏完整渲染时间为5.9s，初始交互时间为6.5s。</p>
<p><img src="http://p0.qhimg.com/t0134c41d17a1a047b8.png" alt=""></p>
<h3 id="1-2-基础的React单页应用"><a href="#1-2-基础的React单页应用" class="headerlink" title="1.2 基础的React单页应用"></a>1.2 基础的React单页应用</h3><p>它们第一次迭代重构Treebo是用React和简单的<a href="https://webpack.js.org/" target="_blank" rel="external">webpack</a>来构建一个<strong>单页应用</strong>。</p>
<p>你可以看下之前写的代码。这导致生成了简单(巨大)的Javascript和CSS包(bundles)。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* webpack.js */</span></div><div class="line"></div><div class="line"><span class="symbol"> entry:</span> &#123;</div><div class="line"><span class="symbol">     main:</span> <span class="string">'./client/index.js'</span>,</div><div class="line"> &#125;,</div><div class="line"><span class="symbol"> output:</span> &#123;</div><div class="line"><span class="symbol">     path:</span> path.resolve(<span class="string">'./build/client'</span>),</div><div class="line"><span class="symbol">     filename:</span> <span class="string">'js/[name].[chunkhash:8].js'</span>,</div><div class="line"> &#125;,</div><div class="line"><span class="symbol"> module:</span> &#123;</div><div class="line"><span class="symbol">     rules:</span> [</div><div class="line">         &#123; <span class="string">test:</span> <span class="regexp">/\.js$/</span>, <span class="string">exclude:</span> <span class="regexp">/node_modules/</span>, <span class="string">use:</span> [<span class="string">'babel-loader'</span>] &#125;,</div><div class="line">         &#123; <span class="string">test:</span> <span class="regexp">/\.css$/</span>, <span class="string">loader:</span> ExtractTextPlugin.extract(&#123; <span class="string">fallback:</span> [<span class="string">'style-loader'</span>], <span class="string">use:</span> [<span class="string">'css-loader'</span>] &#125;) &#125;,</div><div class="line">     ],</div><div class="line"> &#125;</div><div class="line"> <span class="keyword">new</span> ExtractTextPlugin(<span class="string">'css/[name].[contenthash:8].css'</span>),</div></pre></td></tr></table></figure>
<p>这次版本的首屏渲染时间为4.8s，初始交互时间大约5.6s，完整的首屏图片加载时间在7.2s。</p>
<p><img src="http://p0.qhimg.com/t0159387cee8ad9729c.png" alt=""></p>
<h3 id="1-3服务端渲染（SSR）"><a href="#1-3服务端渲染（SSR）" class="headerlink" title="1.3服务端渲染（SSR）"></a>1.3服务端渲染（SSR）</h3><p>接着，他们着手优化首屏渲染时间，所以他们尝试了<strong>服务端渲染</strong>。<strong>有一点值得注意，服务端渲染并不是没有副作用。它优化的同时也会消耗其他性能</strong>。</p>
<blockquote>
<p>使用<a href="https://css-tricks.com/server-side-react-rendering/" target="_blank" rel="external">服务端渲染</a>,你服务端给浏览器的返回就是你即将重绘页面的HTML，这样浏览器可以不需要等待所有Javascript加载和执行才能渲染页面。</p>
</blockquote>
<p>Treebo使用React的<a href="https://facebook.github.io/react/docs/react-dom-server.html#rendertostring" target="_blank" rel="external">renderToString()</a>将组件渲染为一段HTML字符串，并在应用初始化的时候注入state。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">// reactMiddleware.js</div><div class="line"> const serverRenderedHtml = async (req, res, renderProps) =&gt; &#123;</div><div class="line">     const store = configureStore();</div><div class="line">     //call, wait, and set api responses into redux store's state (ghub.io/redux-connect)</div><div class="line">     await loadOnServer(&#123; ...renderProps, store &#125;);</div><div class="line">     //render the html template</div><div class="line">     const template = html(</div><div class="line">         renderToString(</div><div class="line">         <span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;store&#125;</span> <span class="attr">key</span>=<span class="string">"provider"</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">ReduxAsyncConnect</span> &#123;<span class="attr">...renderProps</span>&#125; /&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span>,</div><div class="line">         ),</div><div class="line">         store.getState(),</div><div class="line">     );</div><div class="line">     res.send(template);</div><div class="line"> &#125;;</div><div class="line"> const html = (app, initialState) =&gt; `</div><div class="line">     <span class="meta">&lt;!doctype html&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"$&#123;assets.main.css&#125;"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span>&gt;</span>$&#123;app&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">window</span>.__INITIAL_STATE__ = $&#123;<span class="built_in">JSON</span>.stringify(initialState)&#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$&#123;assets.main.js&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">html</span>&gt;</span></div><div class="line"> `;</div></pre></td></tr></table></figure>
<p>在Treebo的例子中，使用服务端渲染，首屏渲染时间减少到1.1s，首屏完整渲染时间减少到2.4s - 这提高了用户在页面加载速度的感知，他们可以更提前获取内容，而且在测试中显示在SEO也略微改善。但是缺点就是在初始交互时间有糟糕的影响。</p>
<p><img src="http://p0.qhimg.com/t016792643ffe9a6792.png" alt=""></p>
<p>尽管用户可以看到网站内容，但是当初始化加载javascript时主线程被阻塞了，并且就堵在那里。</p>
<p><strong>使用SSR，浏览器需要比之前请求处理更大的HTMl负载，并且接着请求，解析／编译，执行Javascript。虽然这样高效的做了更多工作。</strong></p>
<p>但这意味着第一次交互时间需要6.6s，反而不如之前了。</p>
<p>SSR也可以通过锁定下游设备的主线程来缩短TTI。(译者注：<a href="https://en.wikipedia.org/wiki/Transmission_Time_Interval" target="_blank" rel="external">Transmission Time Interval</a>传输时间间隔)</p>
<h3 id="1-4-基于路由的代码分割和按需加载"><a href="#1-4-基于路由的代码分割和按需加载" class="headerlink" title="1.4 基于路由的代码分割和按需加载"></a>1.4 基于路由的代码分割和按需加载</h3><p>接下来Treebo要做的就是<strong>按需加载</strong>，可以减少初始交互时间。</p>
<blockquote>
<p><a href="https://gist.github.com/addyosmani/44678d476b8843fd981ff8011d389724" target="_blank" rel="external">按需加载</a>目的在于给一个路由页面的交互提供其所需要的最少代码，通过<a href="https://webpack.js.org/guides/code-splitting/" target="_blank" rel="external">code-splitting</a>将路由分割成按需加载的“块”。这样让加载的资源更接近于开发者写的模块粒度。</p>
</blockquote>
<p>他们在这块的做法是，把他们的第三方依赖库，Webpack runtime manifests，和他们的路由分割成单独的块。(译者注：需要理解<a href="https://doc.webpack-china.org/concepts/manifest/" target="_blank" rel="external">webpack 的 runtime 和 manifest，可以点进来看看</a>)</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="xml">// reactMiddleware.js</span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml"> //add the webpackManifest and vendor script files to your html</span></div><div class="line"><span class="xml"> <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></div><div class="line"><span class="xml"> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span>&gt;</span>$</span><span class="template-variable">&#123;app&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></div><div class="line"><span class="xml"> <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">window</span>.__INITIAL_STATE__ = $</span></span><span class="template-variable">&#123;JSON.stringify(initialState)&#125;</span><span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;assets.webpackManifest.js&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;assets.vendor.js&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;assets.main.js&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></div></pre></td></tr></table></figure>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// vendor.js</span></div><div class="line"></div><div class="line"> <span class="meta"><span class="meta-keyword">import</span> 'redux-pack';</span></div><div class="line"> <span class="meta"><span class="meta-keyword">import</span> 'redux-segment';</span></div><div class="line"> <span class="meta"><span class="meta-keyword">import</span> 'redux-thunk';</span></div><div class="line"> <span class="meta"><span class="meta-keyword">import</span> 'redux';</span></div><div class="line"> <span class="comment">// import other external dependencies</span></div></pre></td></tr></table></figure>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// webpack.js</span></div><div class="line"></div><div class="line"> <span class="attribute">entry</span>: &#123;</div><div class="line">   <span class="attribute">main</span>: <span class="string">'./client/index.js'</span>,</div><div class="line">   <span class="attribute">vendor</span>: <span class="string">'./client/vendor.js'</span>,</div><div class="line"> &#125;,</div><div class="line"> <span class="selector-tag">new</span> <span class="selector-tag">webpack</span><span class="selector-class">.optimize</span><span class="selector-class">.CommonsChunkPlugin</span>(&#123;</div><div class="line">   <span class="attribute">names</span>: [<span class="string">'vendor'</span>, <span class="string">'webpackManifest'</span>],</div><div class="line">   <span class="attribute">minChunks</span>: Infinity,</div><div class="line"> &#125;),</div></pre></td></tr></table></figure>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// routes.js</span></div><div class="line"></div><div class="line"> &lt;Route</div><div class="line">     name=<span class="string">"landing"</span></div><div class="line">     path=<span class="string">"/"</span></div><div class="line">     getComponent=&#123;</div><div class="line">     (_, cb) =&gt; <span class="keyword">import</span>(<span class="string">'./views/LandingPage/LandingPage'</span> <span class="comment">/* webpackChunkName: 'landing' */</span>)</div><div class="line">     .then(<span class="function">(<span class="params"><span class="built_in">module</span></span>) =&gt;</span> cb(<span class="literal">null</span>, <span class="built_in">module</span>.<span class="keyword">default</span>))</div><div class="line">     .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> cb(error, <span class="literal">null</span>))</div><div class="line">     &#125;</div><div class="line"> &gt;</div><div class="line"> &lt;<span class="regexp">/Route&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// webpack.js</span></div><div class="line"></div><div class="line"> <span class="comment">//extract css from all the split chunks into main.hash.css</span></div><div class="line"> <span class="keyword">new</span> ExtractTextPlugin(&#123;</div><div class="line">   filename: <span class="string">'css/[name].[contenthash:8].css'</span>,</div><div class="line">   allChunks: <span class="literal">true</span>,</div><div class="line"> &#125;),</div></pre></td></tr></table></figure>
<p>这直接将初始交互时间减少到4.8s了。帅呆了！</p>
<p>唯一不够理想的是需要在初始化的bundles被执行完才会开始下载当前页面的Javascript。</p>
<p>但它至少在体验上提升了不少。对于按需加载，代码分割和这次体验的提升，他们做了一些更隐性的改进。他们通过webpack 的import方法调用React Router声明支持的getComponent来异步加载到各个模块中。(译者注：<a href="https://react-guide.github.io/react-router-cn/docs/guides/advanced/DynamicRouting.html" target="_blank" rel="external">想了解getComponent可以点进来</a>)</p>
<p><img src="http://p0.qhimg.com/t017be4bca1ea2d392c.png" alt=""></p>
<h3 id="1-5-PRPL性能模式"><a href="#1-5-PRPL性能模式" class="headerlink" title="1.5 PRPL性能模式"></a>1.5 PRPL性能模式</h3><p>按需加载对于代码更颗粒化的运行和缓存是非常赞的第一步。Treebo想再优化，并在<a href="https://developers.google.com/web/fundamentals/performance/prpl-pattern/" target="_blank" rel="external"><strong>PRPL 模式</strong></a>上找到了灵感。</p>
<blockquote>
<p>PRPL是一种用于结构化和提供 Progressive Web App (PWA) 的模式，该模式强调应用交付和启动的性能。</p>
</blockquote>
<p>它代表：</p>
<ul>
<li><p><strong>推送</strong> - 为初始网址路由推送关键资源。</p>
</li>
<li><p><strong>渲染</strong> - 渲染初始路由。</p>
</li>
<li><p><strong>预缓存</strong> - 预缓存剩余路由。</p>
</li>
<li><p><strong>延迟加载</strong> - 延迟加载并按需创建剩余路由。</p>
</li>
</ul>
<p><img src="http://p0.qhimg.com/t01a9d211b7229f4abc.png" alt=""></p>
<p>Jimmy Moon做的一份PRPL的结构图</p>
<p>“推送”部分推荐给服务器/浏览器组合设计一个离散的结构，以便在优化缓存的同时，支持HTTP/2传递给浏览器首屏光速渲染所需的资源。这些资源的传递可以通过<a href="https://developers.google.com/web/updates/2016/03/link-rel-preload" target="_blank" rel="external"><code>&lt;link ref=&quot;preload&quot;&gt;</code></a>或者<a href="https://developers.google.com/web/fundamentals/performance/http2/#server-push" target="_blank" rel="external">HTTP/2 Push</a>来高效完成。</p>
<p>Treebo选择使用<code>&lt;link rel=”preload” /&gt;</code>加载当前路由模块。当初始模块执行完后，webpack回调获取当前路由，当前路由模块已经在缓存中了，这样就减少初始交互时间。所以现在初始交互时间在4.6s时就开始了。</p>
<p><img src="http://p0.qhimg.com/t0162f2cade10bfc7e2.png" alt=""></p>
<p>使用preload唯一不好的就是它并没有支持跨浏览器。目前，Safari已经支持link rel preload特性。我希望今年它会持续落实。目前Firefox也正在落实进行中。</p>
<h3 id="1-6-HTML流"><a href="#1-6-HTML流" class="headerlink" title="1.6 HTML流"></a>1.6 HTML流</h3><blockquote>
<p>使用<code>renderToString()</code>的缺点之一是它是异步的，这会成为React项目中服务端渲染的性能瓶颈。服务器直到全部HTML被创建后才会发送<br>请求。当web服务器输出网站内容时，浏览器会在全部请求完成之前渲染页面给用户。类似<a href="https://github.com/aickin/react-dom-stream" target="_blank" rel="external">react-dom-stream</a>这样的项目可以对此有所帮助。</p>
</blockquote>
<p>为了提高他们的app感知性能，并引入一种渐进式渲染的感觉，Treebo使用了<strong>HTML流</strong>。他们会优先输出那些带有link rel preload的头部标签，这样可以预加载CSS和Javascript。然后再执行服务端渲染，并把剩下的资源发送给浏览器。</p>
<p>这样做的好处是资源比之前更早开始下载，将首屏渲染时间降低到0.9s，初始交互时间降低到4.4s。app始终保持在4.9/5秒的节点才开始交互。</p>
<p><img src="http://p0.qhimg.com/t0199c52807c4497277.png" alt=""></p>
<p>缺点是它在客户端和服务器之间连接会保持一段时间，如果遇到稍长点的延迟时间，可能会出现问题。 针对HTML流，Treebo将传输内容定义成预加载模块，主内容模块和将要加载的模块。 所有这些都被插入到页面中。 就像这样：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">// html.js</div><div class="line"></div><div class="line"> earlyChunk(route) &#123;</div><div class="line">     return `</div><div class="line">         <span class="meta">&lt;!doctype html&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"$&#123;assets.main.css&#125;"</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"preload"</span> <span class="attr">as</span>=<span class="string">"script"</span> <span class="attr">href</span>=<span class="string">"$&#123;assets.webpackManifest.js&#125;"</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"preload"</span> <span class="attr">as</span>=<span class="string">"script"</span> <span class="attr">href</span>=<span class="string">"$&#123;assets.vendor.js&#125;"</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"preload"</span> <span class="attr">as</span>=<span class="string">"script"</span> <span class="attr">href</span>=<span class="string">"$&#123;assets.main.js&#125;"</span>&gt;</span></div><div class="line">             $&#123;!assets[route.name] ? '' : `<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"preload"</span> <span class="attr">as</span>=<span class="string">"script"</span> <span class="attr">href</span>=<span class="string">"$&#123;assets[route.name].js&#125;"</span>&gt;</span>`&#125;</div><div class="line">         <span class="tag">&lt;/<span class="name">head</span>&gt;</span>`;</div><div class="line"> &#125;,</div><div class="line"> lateChunk(app, head, initialState) &#123;</div><div class="line">     return `</div><div class="line">         <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span>&gt;</span>$&#123;app&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">window</span>.__INITIAL_STATE__ = $&#123;<span class="built_in">JSON</span>.stringify(initialState)&#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$&#123;assets.webpackManifest.js&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$&#123;assets.vendor.js&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$&#123;assets.main.js&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">             <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">html</span>&gt;</span></div><div class="line">     `;</div><div class="line"> &#125;,</div></pre></td></tr></table></figure>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// reactMiddleware.js</span></div><div class="line"></div><div class="line"> <span class="keyword">const</span> serverRenderedChunks = async (req, res, renderProps) =&gt; &#123;</div><div class="line">     <span class="keyword">const</span> route = renderProps.routes[renderProps.routes.length - <span class="number">1</span>];</div><div class="line">     <span class="keyword">const</span> store = configureStore();</div><div class="line">     <span class="comment">//set the content type since you're streaming the response</span></div><div class="line">     res.set(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>);</div><div class="line">     <span class="comment">//flush the head with css &amp; js resource tags first so the download starts immediately</span></div><div class="line">     <span class="keyword">const</span> earlyChunk = html.earlyChunk(route);</div><div class="line">     res.<span class="built_in">write</span>(earlyChunk);</div><div class="line">     res.<span class="built_in">flush</span>();</div><div class="line">     <span class="comment">//call &amp; wait for api's response, set them into state</span></div><div class="line">     await loadOnServer(&#123; ...renderProps, store &#125;);</div><div class="line">     <span class="comment">//flush the rest of the body once app the server side rendered</span></div><div class="line">     <span class="keyword">const</span> lateChunk = html.lateChunk(</div><div class="line">         renderToString(</div><div class="line">         &lt;Provider store=&#123;store&#125; key=<span class="string">"provider"</span>&gt;</div><div class="line">             &lt;ReduxAsyncConnect &#123;...renderProps&#125; /&gt;</div><div class="line">         &lt;/Provider&gt;,</div><div class="line">         ),</div><div class="line">         Helmet.renderStatic(),</div><div class="line">         store.getState(),</div><div class="line">         route,</div><div class="line">     );</div><div class="line">     res.<span class="built_in">write</span>(lateChunk);</div><div class="line">     res.<span class="built_in">flush</span>();</div><div class="line">     <span class="comment">//let client know the response has ended</span></div><div class="line">     res.<span class="built_in">end</span>();</div><div class="line"> &#125;;</div></pre></td></tr></table></figure>
<p>对于所有不同的脚本标签，预加载模块已经获取到它们的<code>rel=preload</code>声明。将要加载的模块则获取了服务端返回的html和其他包含state的内容，或者正在使用已经加载的Javascript。</p>
<h3 id="1-7-内联对应路径CSS"><a href="#1-7-内联对应路径CSS" class="headerlink" title="1.7 内联对应路径CSS"></a>1.7 内联对应路径CSS</h3><blockquote>
<p>CSS样式表会阻塞页面的渲染。页面会在浏览器发起请求，接收，下载，并且解析你的样式表之前保持空白。通过减少浏览器需要加载的CSS数量，并把<a href="https://jonassebastianohlsson.com/criticalpathcssgenerator/#what-is" target="_blank" rel="external">对应路径样式</a>内联到页面中，这样就减少了一个HTTP请求，页面就可以更快的渲染。</p>
</blockquote>
<p>Treebo在当前路由支持了<strong>内联对应路径的样式</strong>，并在DOMContentLoaded时使用<a href="https://github.com/filamentgroup/loadCSS" target="_blank" rel="external">loadCSS</a>异步加载剩余的CSS。</p>
<p>这消除了<code>&lt;link&gt;</code>标签对对应路径页面渲染的阻塞，并加入了少量的核心CSS，将首屏渲染时间减少至0.4s。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// fragments.js</span></div><div class="line"></div><div class="line"> <span class="keyword">import</span> assetsManifest <span class="keyword">from</span> <span class="string">'../../build/client/assetsManifest.json'</span>;</div><div class="line"> <span class="comment">//read the styles into an assets object during server startup</span></div><div class="line"> <span class="keyword">export</span> <span class="keyword">const</span> assets = <span class="built_in">Object</span>.keys(assetsManifest)</div><div class="line">     .reduce(<span class="function">(<span class="params">o, entry</span>) =&gt;</span> (&#123;</div><div class="line">         ...o,</div><div class="line">         [entry]: &#123;</div><div class="line">             ...assetsManifest[entry],</div><div class="line">             styles: assetsManifest[entry].css ?    fs.readFileSync(<span class="string">`build/client/css/<span class="subst">$&#123;assetsManifest[entry].css.split(<span class="string">'/'</span>).pop()&#125;</span>`</span>, <span class="string">'utf8'</span>) : <span class="literal">undefined</span>,</div><div class="line">         &#125;,</div><div class="line">     &#125;), &#123;&#125;);</div><div class="line">     <span class="keyword">export</span> <span class="keyword">const</span> scripts = &#123;</div><div class="line">         <span class="comment">//loadCSS by filamentgroup</span></div><div class="line">         loadCSS: <span class="string">'var loadCSS=function(e,n,t)&#123;func...'</span>,</div><div class="line">         loadRemainingCSS(route) &#123;</div><div class="line">             <span class="keyword">return</span> <span class="built_in">Object</span>.keys(assetsManifest)</div><div class="line">                 .filter(<span class="function">(<span class="params">entry</span>) =&gt;</span> assetsManifest[entry].css &amp;&amp; entry !== route.name &amp;&amp; entry !== <span class="string">'main'</span>)</div><div class="line">                 .reduce(<span class="function">(<span class="params">s, entry</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;s&#125;</span>loadCSS("<span class="subst">$&#123;assetsManifest[entry].css&#125;</span>");`</span>, <span class="keyword">this</span>.loadCSS);</div><div class="line">     &#125;,</div><div class="line"> &#125;;</div></pre></td></tr></table></figure>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="xml">// html.js</span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml">//use the assets object to inline styles into your lateChunk template generation logic during runtime</span></div><div class="line"><span class="xml"> lateChunk(route) </span><span class="template-variable">&#123;</span></div><div class="line"><span class="template-variable">     return `</span></div><div class="line"><span class="template-variable">                &lt;style&gt;$&#123;assets.main.styles&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></div><div class="line"><span class="xml">                <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">$</span></span><span class="template-variable">&#123;assets[route.name].styles&#125;</span><span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></div><div class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></div><div class="line"><span class="xml">            <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></div><div class="line"><span class="xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span>&gt;</span>$</span><span class="template-variable">&#123;app&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></div><div class="line"><span class="xml">                <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">window</span>.__INITIAL_STATE__ = $</span></span><span class="template-variable">&#123;JSON.stringify(initialState)&#125;</span><span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml">                <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;assets.webpackManifest.js&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml">                <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;assets.vendor.js&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml">                <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;assets.main.js&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml">                <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">$</span></span><span class="template-variable">&#123;scripts.loadRemainingCSS(route)&#125;</span><span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></div><div class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></div><div class="line"><span class="xml">     `;</span></div><div class="line"><span class="xml"> &#125;,</span></div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">// webpack.client.js</div><div class="line"></div><div class="line">//<span class="keyword">replace</span> ExtractTextPlugin <span class="keyword">with</span> ExtractCssChunks <span class="keyword">from</span> <span class="string">'extract-css-chunks-webpack-plugin'</span></div><div class="line"> <span class="keyword">module</span>: &#123;</div><div class="line">     <span class="keyword">rules</span>: isProd ? [</div><div class="line">         &#123; <span class="keyword">test</span>: /\.js$/, <span class="keyword">exclude</span>: /node_modules/, <span class="keyword">use</span>: [<span class="string">'babel-loader'</span>] &#125;,</div><div class="line">         &#123; <span class="keyword">test</span>: /\.css$/, loader: ExtractCssChunks.extract(&#123; <span class="keyword">use</span>: [&#123; loader: <span class="string">'css-loader'</span>, options: &#123; importLoaders: <span class="number">1</span> &#125; &#125;, <span class="string">'postcss-loader'</span>] &#125;) &#125;,</div><div class="line"> //...</div><div class="line"> plugins: [</div><div class="line">     <span class="keyword">new</span> ExtractCssChunks(<span class="string">'css/[name].[contenthash:8].css'</span>),</div><div class="line">     //this generates a css <span class="keyword">chunk</span> alongside the js <span class="keyword">chunk</span> <span class="keyword">for</span> <span class="keyword">each</span> dynamic <span class="keyword">import</span>() <span class="keyword">call</span> (route-<span class="keyword">split</span> <span class="keyword">path</span> <span class="keyword">in</span> our <span class="keyword">case</span>) <span class="keyword">for</span> eg,</div><div class="line">     //main.hash.js, main.hash.css</div><div class="line">     //landing.hash.js, landing.hash.css</div><div class="line">     //cities.hash.js, cities.hash.css</div><div class="line">     //the landing.hash.css <span class="keyword">and</span> cities.hash.css will contain the css <span class="keyword">rules</span> <span class="keyword">for</span> their respective chunks</div><div class="line">     //but will also contain <span class="keyword">shared</span> <span class="keyword">rules</span> <span class="keyword">between</span> them <span class="keyword">like</span> button, grid, typography css <span class="keyword">and</span> so <span class="keyword">on</span></div><div class="line">     //<span class="keyword">to</span> <span class="keyword">extract</span> these <span class="keyword">shared</span> <span class="keyword">rules</span> <span class="keyword">to</span> the main.hash.css <span class="keyword">use</span> the CommonsChunkPlugin</div><div class="line">     //bonus: this also extracts the common js code <span class="keyword">shared</span> <span class="keyword">between</span> landing.hash.js <span class="keyword">and</span> cities.hash.js <span class="keyword">into</span> main.hash.js</div><div class="line">     <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</div><div class="line">         children: <span class="literal">true</span>,</div><div class="line">         minChunks: <span class="number">2</span>,</div><div class="line">     &#125;),</div><div class="line">     //<span class="keyword">use</span> the assets-webpack-<span class="keyword">plugin</span> <span class="keyword">to</span> <span class="keyword">get</span> a manifest <span class="keyword">of</span> all the <span class="keyword">generated</span> files</div><div class="line">     <span class="keyword">new</span> AssetsPlugin(&#123;</div><div class="line">         filename: <span class="string">'assetsManifest.json'</span>,</div><div class="line">         <span class="keyword">path</span>: path.resolve(<span class="string">'./build/client'</span>),</div><div class="line">         prettyPrint: <span class="literal">true</span>,</div><div class="line">     &#125;),</div><div class="line"> //...</div></pre></td></tr></table></figure>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="xml">// html.js</span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml">//use the assets object to inline styles into your lateChunk template generation logic during runtime</span></div><div class="line"><span class="xml"> lateChunk(route) </span><span class="template-variable">&#123;</span></div><div class="line"><span class="template-variable">     return `</span></div><div class="line"><span class="template-variable">                 &lt;style&gt;$&#123;assets.main.styles&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></div><div class="line"><span class="xml">                 <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">$</span></span><span class="template-variable">&#123;assets[route.name].styles&#125;</span><span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></div><div class="line"><span class="xml">             <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></div><div class="line"><span class="xml">             <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></div><div class="line"><span class="xml">                 <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span>&gt;</span>$</span><span class="template-variable">&#123;app&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></div><div class="line"><span class="xml">                 <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">window</span>.__INITIAL_STATE__ = $</span></span><span class="template-variable">&#123;JSON.stringify(initialState)&#125;</span><span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml">                 <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;assets.webpackManifest.js&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml">                 <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;assets.vendor.js&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml">                 <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;assets.main.js&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml">                 <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">$</span></span><span class="template-variable">&#123;scripts.loadRemainingCSS(route)&#125;</span><span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml">             <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></div><div class="line"><span class="xml">         <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></div><div class="line"><span class="xml">     `;</span></div><div class="line"><span class="xml"> &#125;,</span></div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">// webpack.client.js</div><div class="line">//<span class="keyword">replace</span> ExtractTextPlugin <span class="keyword">with</span> ExtractCssChunks <span class="keyword">from</span> <span class="string">'extract-css-chunks-webpack-plugin'</span></div><div class="line"> <span class="keyword">module</span>: &#123;</div><div class="line">     <span class="keyword">rules</span>: isProd ? [</div><div class="line">         &#123; <span class="keyword">test</span>: /\.js$/, <span class="keyword">exclude</span>: /node_modules/, <span class="keyword">use</span>: [<span class="string">'babel-loader'</span>] &#125;,</div><div class="line">         &#123; <span class="keyword">test</span>: /\.css$/, loader: ExtractCssChunks.extract(&#123; <span class="keyword">use</span>: [&#123; loader: <span class="string">'css-loader'</span>, options: &#123; importLoaders: <span class="number">1</span> &#125; &#125;, <span class="string">'postcss-loader'</span>] &#125;) &#125;,</div><div class="line">         //...</div><div class="line"> plugins: [</div><div class="line">     <span class="keyword">new</span> ExtractCssChunks(<span class="string">'css/[name].[contenthash:8].css'</span>),</div><div class="line">     //this generates a css <span class="keyword">chunk</span> alongside the js <span class="keyword">chunk</span> <span class="keyword">for</span> <span class="keyword">each</span> dynamic <span class="keyword">import</span>() <span class="keyword">call</span> (route-<span class="keyword">split</span> <span class="keyword">path</span> <span class="keyword">in</span> our <span class="keyword">case</span>) <span class="keyword">for</span> eg,</div><div class="line">     //main.hash.js, main.hash.css</div><div class="line">     //landing.hash.js, landing.hash.css</div><div class="line">     //cities.hash.js, cities.hash.css</div><div class="line">     //the landing.hash.css <span class="keyword">and</span> cities.hash.css will contain the css <span class="keyword">rules</span> <span class="keyword">for</span> their respective chunks</div><div class="line">     //but will also contain <span class="keyword">shared</span> <span class="keyword">rules</span> <span class="keyword">between</span> them <span class="keyword">like</span> button, grid, typography css <span class="keyword">and</span> so <span class="keyword">on</span></div><div class="line">     //<span class="keyword">to</span> <span class="keyword">extract</span> these <span class="keyword">shared</span> <span class="keyword">rules</span> <span class="keyword">to</span> the main.hash.css <span class="keyword">use</span> the CommonsChunkPlugin</div><div class="line">     //bonus: this also extracts the common js code <span class="keyword">shared</span> <span class="keyword">between</span> landing.hash.js <span class="keyword">and</span> cities.hash.js <span class="keyword">into</span> main.hash.js</div><div class="line">     <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</div><div class="line">         children: <span class="literal">true</span>,</div><div class="line">         minChunks: <span class="number">2</span>,</div><div class="line">     &#125;),</div><div class="line">     //<span class="keyword">use</span> the assets-webpack-<span class="keyword">plugin</span> <span class="keyword">to</span> <span class="keyword">get</span> a manifest <span class="keyword">of</span> all the <span class="keyword">generated</span> files</div><div class="line">     <span class="keyword">new</span> AssetsPlugin(&#123;</div><div class="line">         filename: <span class="string">'assetsManifest.json'</span>,</div><div class="line">         <span class="keyword">path</span>: path.resolve(<span class="string">'./build/client'</span>),</div><div class="line">         prettyPrint: <span class="literal">true</span>,</div><div class="line">     &#125;),</div><div class="line">     //...</div></pre></td></tr></table></figure>
<p>缺点就是首屏渲染时间稍微增加到4.6s，因为内联样式使加载资源更大，并且在Javascript执行之前解析也需要时间。</p>
<p><img src="http://p0.qhimg.com/t0179e9c65426dde6c2.png" alt=""></p>
<h3 id="1-8-离线静态资源缓存"><a href="#1-8-离线静态资源缓存" class="headerlink" title="1.8 离线静态资源缓存"></a>1.8 离线静态资源缓存</h3><blockquote>
<p><a href="https://developers.google.com/web/fundamentals/getting-started/primers/service-workers" target="_blank" rel="external">Service Worker</a>是一种可编程网络代理，让你能够控制页面所发送网络请求的处理方式。</p>
</blockquote>
<p>Treebo添加了Service Worker以支持静态资源以及自定义离线页面的缓存。下面我可以看到Service Worker的注册和他们如何使用<a href="https://www.npmjs.com/package/sw-precache-webpack-plugin" target="_blank" rel="external">sw-precache-webpack-plugin</a>来缓存资源。</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// fragments.js</span></div><div class="line"> <span class="comment">// register the service worker after the onload event to prevent</span></div><div class="line"> <span class="comment">// bandwidth resource contention during the main and vendor js downloads</span></div><div class="line"> export const scripts = &#123;</div><div class="line">     serviceWorker:</div><div class="line">         `<span class="string">"serviceWorker"</span> in window.navigator &amp;&amp; window.addEventListener(<span class="string">"load"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> &#123;</span></div><div class="line">             window.navigator.serviceWorker.register(<span class="string">"/serviceWorker.js"</span>)</div><div class="line">             .<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(r)</span> &#123;</span></div><div class="line">             console.<span class="built_in">log</span>(<span class="string">"ServiceWorker registration successful with scope: "</span>, r.scope)</div><div class="line">             &#125;).<span class="keyword">catch</span>(<span class="function"><span class="keyword">function</span><span class="params">(e)</span> &#123;</span></div><div class="line">             console.<span class="built_in">error</span>(<span class="string">"ServiceWorker registration failed: "</span>, e)</div><div class="line">             &#125;)</div><div class="line">         &#125;);`,</div><div class="line"> &#125;;</div></pre></td></tr></table></figure>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="xml">// html.js</span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;assets.webpackManifest.js&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;assets.vendor.js&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;assets.main.js&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml"> <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">$</span></span><span class="template-variable">&#123;scripts.loadRemainingCSS(route)&#125;</span><span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line"><span class="xml"> //add the serviceWorker script to your html template</span></div><div class="line"><span class="xml"> <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">$</span></span><span class="template-variable">&#123;scripts.serviceWorker&#125;</span><span class="xml"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// server.js</span></div><div class="line"></div><div class="line"> <span class="comment">//serve it at the root level scope</span></div><div class="line"> app.<span class="keyword">use</span>(<span class="string">'/serviceWorker.js'</span>, express.<span class="keyword">static</span>(<span class="string">'build/client/serviceWorker.js'</span>));</div></pre></td></tr></table></figure>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// webpack.js</span></div><div class="line"></div><div class="line"> <span class="keyword">new</span> SWPrecacheWebpackPlugin(&#123;</div><div class="line">     cacheId: <span class="string">'app-name'</span>,</div><div class="line">     filename: <span class="string">'serviceWorker.js'</span>,</div><div class="line">     staticFileGlobsIgnorePatterns: [<span class="regexp">/\.map$/</span>, <span class="regexp">/manifest/i</span>],</div><div class="line">     dontCacheBustUrlsMatching: <span class="regexp">/./</span>,</div><div class="line">     minify: <span class="keyword">true</span>,</div><div class="line"> &#125;),</div></pre></td></tr></table></figure>
<p><img src="http://p0.qhimg.com/t0162913d96c30e53c7.png" alt=""></p>
<p>缓存静态资源（比如CSS和Javascript包）意味着页面在反复访问时可以立即从硬盘缓存中加载，而不是需要每次都请求服务器。关于硬盘缓存命中率，硬盘定义的缓存头可以产生同样的效果，但是Service Worker给我们提供了离线支持。</p>
<p><img src="http://p0.qhimg.com/t015a1a1f18dea2f3ab.png" alt=""></p>
<p>在缓存Javascript时，Service Worker使用了缓存API(如我们在<a href="https://medium.com/reloading/javascript-start-up-performance-69200f43b201" target="_blank" rel="external">JavaScript 性能入门</a>一文中提到的)，使得Treebo在V8的代码缓存中也有不俗的优先选择，这样Treebo在反复访问时的启动节省了一点时间。</p>
<p>接下来，Treebo想尝试减少他们第三方插件包的大小和JS的执行时间，于是他们在生产环境将React换成了<strong>Preact</strong>。</p>
<h3 id="1-9-Preact替换React"><a href="#1-9-Preact替换React" class="headerlink" title="1.9 Preact替换React"></a>1.9 Preact替换React</h3><p><a href="http://preactjs.com" target="_blank" rel="external">Preact</a>是一个跟React同样使用ES2015 API，精简到3KB的替代方案。它旨在提供高性能渲染，并且与React生态系统的其余部分（如Redux）配合使用（preact-compat）。</p>
<p>Preact精简的部分在于删除了合成事件(Synthetic Events)和PropType验证。 另外它还包含：</p>
<ul>
<li><p>虚拟DOM(Virtual DOM)和真实DOM的对比</p>
</li>
<li><p>支持class和for的props</p>
</li>
<li><p>在render方法中传入了(props, state)</p>
</li>
<li><p>使用标准浏览器事件</p>
</li>
<li><p>完全支持异步渲染</p>
</li>
<li><p>SubTree默认无效</p>
</li>
</ul>
<p>在很多PWA应用中，替换成Preact可以让应用减小JS包的大小，并且缩短了Javascript初始化时间。最近发布的PWA，例如Lyft， Uber和 Housing.com都在生产环境使用了Preact。</p>
<p><strong>注意：如果你的项目是React开发的，并且你想换成Preact？ 理想情况下，您应该使用preact和preact-compat来进行开发，生产和测试。 这可以让你在早期发现任何交互操作性错误。 如果你只想在Webpack中仅使用别名preact和preact-compat生成构建（例如，如果你最开始使用Enzyme），请确保在部署到服务器之前彻底测试一切正常工作。</strong></p>
<p>在Treebo的案例中，转换成Preact让他们的第三方包大小直接从140kb降到100kb。当然，全都是gzip之后的。这让Treebo成功的在目标移动设备将初始交互时间从<strong>4.6s降低到3.9s</strong>。</p>
<p><img src="http://p0.qhimg.com/t018b21f7926acf5e03.png" alt=""></p>
<p>你可以在你的Webpack里面配置alias，react对应<a href="https://github.com/developit/preact-compat" target="_blank" rel="external">preact-compat</a>,react-dom也对应preact-compat。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// webpack.js</span></div><div class="line"></div><div class="line"> <span class="attribute">resolve</span>: &#123;</div><div class="line">     <span class="attribute">alias</span>: &#123;</div><div class="line">          <span class="attribute">react</span>: <span class="string">'preact-compat'</span>,</div><div class="line">         <span class="string">'react-dom'</span>: <span class="string">'preact-compat'</span>,</div><div class="line">     &#125;,</div><div class="line"> &#125;,</div></pre></td></tr></table></figure>
<p>这种方法的缺点是，需要兼容其他配套方案，这样Preact才能在他们想使用的React生态的各部分中同样工作</p>
<p>如果你正在使用React，Preact对于95%的案例来说都是最合适的选择；对于另外那5%，你可能需要给那些尚未考虑的边缘案例提交bug。</p>
<p>注意：由于WebPageTest目前还不支持测试印度真实的Moto G4s，性能测试是在“孟买 - EC2 - Chrome - 仿真摩托罗拉G（第4代） - 3GSlow - 手机”设置下运行的。 如果你想看看这些记录，可以在<a href="https://gist.github.com/addyosmani/d2fc259e1f1d19b64ae0fcbdfac025a2" target="_blank" rel="external">这里</a>找到它们。</p>
<h3 id="1-10-加载占位图"><a href="#1-10-加载占位图" class="headerlink" title="1.10 加载占位图"></a>1.10 <strong>加载占位图</strong></h3><blockquote>
<p>“加载占位图本质上是内容逐渐加载的一个空白页面。”</p>
<p>~Luke Wroblewski</p>
</blockquote>
<p><img src="http://p0.qhimg.com/t01c0cea29058763436.png" alt=""></p>
<p>Treebo想使用预览组件(类似给每个组件添加加载占位图)来加载占位。这个方法的本质就是给所有基础组件(文本，图片等)添加一个预览组件，这样一旦组件所需的数据源还没加载出来，就会显示组件对应的预览组件。</p>
<p>例如，你正在上面这个列表中看到的酒店名称，城市名称，价格等内容，他们使用排版组件类似,添加两个额外的prop，<code>preview</code>和<code>previewStyle</code>来实现。</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="xml">// Text.js</span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml"> <span class="tag">&lt;<span class="name">Text</span></span></span></div><div class="line"><span class="xml">     preview=</span><span class="template-variable">&#123;!hotel.name&#125;</span><span class="xml"></span></div><div class="line"><span class="xml">     previewStyle=</span><span class="template-variable">&#123;&#123;width: 80%&#125;</span><span class="xml">&#125;</span></div><div class="line"><span class="xml"> &gt;</span></div><div class="line"><span class="xml">     </span><span class="template-variable">&#123;hotel.name&#125;</span><span class="xml"></span></div><div class="line"><span class="xml"> <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></div></pre></td></tr></table></figure>
<p>基本上，如果hotel.name不存在，则组件会将背景更改为灰色，并根据传递的previewStyle设置宽度和其他样式（如果没有预览样式传递，则默认为100％）。</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// text.css</span></div><div class="line"> <span class="selector-class">.text</span> &#123;</div><div class="line">     <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</div><div class="line">     <span class="attribute">color</span>: var(--color-secondary);</div><div class="line">     &amp;--preview &#123;</div><div class="line">         <span class="attribute">opacity</span>: <span class="number">0.1</span>;</div><div class="line">         <span class="attribute">height</span>: <span class="number">13px</span>;</div><div class="line">         <span class="attribute">width</span>: <span class="number">100%</span>;</div><div class="line">         <span class="attribute">background</span>: var(--color-secondary);</div><div class="line">     &#125;</div><div class="line">     @<span class="keyword">media</span> (--medium-screen) &#123;</div><div class="line">         <span class="attribute">font-size</span>: <span class="number">1.4rem</span>;</div><div class="line">         &amp;--preview &#123;</div><div class="line">             <span class="attribute">height</span>: <span class="number">16px</span>;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Text.js</span></div><div class="line"></div><div class="line"> <span class="keyword">import</span> React, &#123; PropTypes &#125; from <span class="string">'react'</span>;</div><div class="line"> <span class="keyword">import</span> <span class="literal">cn</span> from <span class="string">'classnames'</span>;</div><div class="line"> const Text = (&#123;</div><div class="line">     className,</div><div class="line">     <span class="built_in">tag</span>,</div><div class="line">     preview,</div><div class="line">     previewStyle,</div><div class="line">     children,</div><div class="line">     <span class="params">...</span>props</div><div class="line"> &#125;) =&gt;</div><div class="line">     React.createElement(<span class="built_in">tag</span>, &#123;</div><div class="line">         style: preview ? previewStyle : &#123;&#125;,</div><div class="line">         className: <span class="literal">cn</span>(<span class="string">'text'</span>, &#123;</div><div class="line">             <span class="string">'text--preview'</span>: preview,</div><div class="line">         &#125;, className),</div><div class="line">         <span class="params">...</span>props,</div><div class="line">     &#125;, children);</div><div class="line"> Text.propTypes = &#123;</div><div class="line">     className: PropTypes.<span class="built_in">string</span>,</div><div class="line">     <span class="built_in">tag</span>: PropTypes.<span class="built_in">string</span>.isRequired,</div><div class="line">     preview: PropTypes.bool.isRequired,</div><div class="line">     previewStyle: PropTypes.object,</div><div class="line">     children: PropTypes.node,</div><div class="line"> &#125;;</div><div class="line"> Text.defaultProps = &#123;</div><div class="line">     <span class="built_in">tag</span>: <span class="string">'p'</span>,</div><div class="line">     preview: <span class="literal">false</span>,</div><div class="line"> &#125;;</div><div class="line"> export default Text;</div></pre></td></tr></table></figure>
<p>Treebo喜欢这种方法是因为，切换到预览模式的逻辑与实际展示的数据无关，这样看起来更灵活。当你在浏览“包含xx所有税”部分时，它就只是静态文字，在开始时可能正常显示，但是当api调用时，价格仍在加载，就会让用户感觉很困惑。</p>
<p>所以为了在剩下的ui中把静态文字“包含xx所有税”展示在预览模式，他们使用价格本身作为逻辑判断。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// TextPreview.js</div><div class="line"></div><div class="line"> <span class="tag">&lt;<span class="name">Text</span> <span class="attr">preview</span>=<span class="string">&#123;!price.sellingPrice&#125;</span>&gt;</span></div><div class="line">     Incl. of all taxes</div><div class="line"> <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这样当价格还在加载时，你会获取到预览的界面，一旦api接口返回成功，你就可以看到展示的数据了。</p>
<h2 id="2-Webpack-bundle-analyzer"><a href="#2-Webpack-bundle-analyzer" class="headerlink" title="2. Webpack-bundle-analyzer"></a>2. <strong>Webpack-bundle-analyzer</strong></h2><p>在这一点，Treebo想做打包分析，这样可以找出一些低频使用的包来优化。</p>
<p><strong>注意：如果你在移动端使用了类似React的库，经常优化你引入的第三方库，是非常重要的。不这样做可能会导致性能问题。考虑如何更好的打包你的第三方库，这样路由只会加载页面所需要的库</strong></p>
<p>Treebo使用<a href="https://www.npmjs.com/package/webpack-bundle-analyzer" target="_blank" rel="external">webpack-bundle-analyzer</a>来跟踪他们包的大小变化，并在每个路由块中监视其中包含的模块。他们也用它来发现可以优化减小包大小的地方，例如去掉moment.js的locales，复用深依赖。</p>
<h3 id="2-1-使用webpack优化moment-js"><a href="#2-1-使用webpack优化moment-js" class="headerlink" title="2.1 使用webpack优化moment.js"></a>2.1 使用webpack优化moment.js</h3><p>Treebo在他们的日期操作重度依赖<a href="https://momentjs.com/" target="_blank" rel="external">moment.js</a>。当你引入了moment.js，并用webpack把它打包，你的包会包含所有moment.js，而它默认的语言包gizp之后都有约61.95kb。这严重增加了最终第三方库打包完的包大小。</p>
<p><img src="http://p0.qhimg.com/t01409886cb87ed8f46.png" alt=""></p>
<p>为了优化moment.js的大小，有<a href="https://github.com/jmblog/how-to-optimize-momentjs-with-webpack" target="_blank" rel="external">两个webpack插件</a>可以用：<a href="https://webpack.js.org/plugins/ignore-plugin/" target="_blank" rel="external">IgnorePlugin</a>, <a href="https://webpack.js.org/plugins/context-replacement-plugin/" target="_blank" rel="external">ContextReplacementPlugin</a></p>
<p>当Treebo不再需要任何语言包，他们选择了IgnorePlugin来移除所有语言文件。</p>
<p><strong>new webpack.IgnorePlugin(/^.\/locale$/, /moment$/)</strong></p>
<p>去除了语言包后，moment.js打包后大小在gizp后降低到约16.48kb。</p>
<p><img src="http://p0.qhimg.com/t010b4bd9347b9d57c3.png" alt=""></p>
<p>作为移除moment.js语言包的边际影响力的最大改善，就是第三方包大小直接从179kb降到119kb。对于首屏加载时一个关键的包，60kb算是大幅度的下降。所有这些都意味着第一次交互时间的大幅度下降。你可以在<a href="https://github.com/jmblog/how-to-optimize-momentjs-with-webpack" target="_blank" rel="external">这里</a>阅读更多关于优化moment.js。</p>
<h3 id="2-2-复用深依赖"><a href="#2-2-复用深依赖" class="headerlink" title="2.2 复用深依赖"></a>2.2 复用深依赖</h3><p>Treebo最开始使用“qs”模块来进行查询字符串操作。在webpack-bundle-analyzer分析的结果中，他们发现“react-router”中包含的“history”模块中包含了“query-string”模块。</p>
<p><img src="http://p0.qhimg.com/t010c140ded0eb2127b.png" alt=""></p>
<p>因为这两个不同的模块都做了相同的操作，在他们源代码中使用当前版本的“query-string”(就是当前安装的)来替换“qs”，又让他们的包gizp后减少2.72kb(也就是“qs”模块的大小)。</p>
<p>Treebo是一个很好的开源参与者。他们使用来大量的开源软件。作为回报，他们也把自己大部分的Webpack配置开源，包含了很多他们在生产环境的配置，可以作为一个模版。你可以在这里找到：<a href="https://github.com/lakshyaranganath/pwa" target="_blank" rel="external">https://github.com/lakshyaranganath/pwa</a></p>
<p><img src="http://p0.qhimg.com/t017ab909526a03a5d6.jpg" alt=""></p>
<p>他们也承诺会尽量保持更新。随着不断完善，您可以把它们作为另一个PWA实现参考。</p>
<h2 id="3-总结和未来"><a href="#3-总结和未来" class="headerlink" title="3. 总结和未来"></a>3. <strong>总结和未来</strong></h2><p>Treebo知道，没有什么应用是完美的，他们积极探索多种方法，不断改进他们向用户提供的经验。其中一些：</p>
<p><strong>懒加载图片</strong></p>
<p>有些人可能从之前的网络瀑布图中了解到，网站图像下载是跟JS下载来竞争带宽。</p>
<p><img src="http://p0.qhimg.com/t01bbc5dea36b8b1f23.png" alt=""></p>
<p>由于浏览器解析img标签后立即触发图片下载，在JS下载过程中它们共享带宽。 一个简单的解决方案是当它们进入用户视图时懒加载图片，这也可以减少我们的交互时间。</p>
<p>Lighthouse在视图外图片审查高亮了这些问题：</p>
<p><img src="http://p0.qhimg.com/t01a93ebe77c0c64bef.png" alt=""></p>
<p><strong>双重引用</strong></p>
<p>Treebo也意识到,虽然他们是异步加载应用的剩余CSS(在加载内联对应路径CSS之后),随着他们的应用发展，从长远来看，这种方法对用户是不可行的。更多的迭代和页面意味着更多的CSS和下载，这些都将导致带宽占用和浪费。</p>
<p>借鉴<a href="https://github.com/filamentgroup/loadCSS" target="_blank" rel="external">loadCSS</a>和<a href="https://github.com/faceyspacey/babel-plugin-dual-import" target="_blank" rel="external">babel-plugin-dual-import</a>的实现方法，Treebo在各自的JS模块中，并行异步执行import(‘chunkpath’)方法，再通过自定义实现的importCss(‘chunkname’)方法返回CSS模块，以此改变加载CSS的方法。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">// html.js</div><div class="line"></div><div class="line"> import assetsManifest from '../../build/client/assetsManifest.json';</div><div class="line"></div><div class="line"> lateChunk(app, head, initialState, route) &#123;</div><div class="line">     return `</div><div class="line">             <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">$&#123;assets.main.styles&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line">             // inline the current route's css and assign an id to it</div><div class="line">             $&#123;!assets[route.name] ? '' : `<span class="tag">&lt;<span class="name">style</span> <span class="attr">id</span>=<span class="string">"$&#123;route.name&#125;.css"</span>&gt;</span><span class="undefined">$&#123;assets[route.name].styles&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>`&#125;</div><div class="line">         <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span>&gt;</span>$&#123;app&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">window</span>.__INITIAL_STATE__ = $&#123;<span class="built_in">JSON</span>.stringify(initialState)&#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">window</span>.__ASSETS_MANIFEST__ = $&#123;<span class="built_in">JSON</span>.stringify(assetsManifest)&#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$&#123;assets.webpackManifest.js&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$&#123;assets.vendor.js&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$&#123;assets.main.js&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">html</span>&gt;</span>`;</div><div class="line"> &#125;,</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// importCSS.js</span></div><div class="line"></div><div class="line"> <span class="keyword">export</span> <span class="keyword">default</span> (chunkName) =&gt; &#123;</div><div class="line">     <span class="keyword">if</span> (!__BROWSER__) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve();</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(chunkName <span class="keyword">in</span> <span class="built_in">window</span>.__ASSETS_MANIFEST__)) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="string">`chunk not found: <span class="subst">$&#123;chunkName&#125;</span>`</span>);</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">window</span>.__ASSETS_MANIFEST__[chunkName].css) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(<span class="string">`chunk css does not exist: <span class="subst">$&#123;chunkName&#125;</span>`</span>);</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">document</span>.getElementById(<span class="string">`<span class="subst">$&#123;chunkName&#125;</span>.css`</span>)) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(<span class="string">`css chunk already loaded: <span class="subst">$&#123;chunkName&#125;</span>`</span>);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">const</span> head = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>];</div><div class="line">     <span class="keyword">const</span> link = <span class="built_in">document</span>.createElement(<span class="string">'link'</span>);</div><div class="line">     link.href = <span class="built_in">window</span>.__ASSETS_MANIFEST__[chunkName].css;</div><div class="line">     link.id = <span class="string">`<span class="subst">$&#123;chunkName&#125;</span>.css`</span>;</div><div class="line">     link.rel = <span class="string">'stylesheet'</span>;</div><div class="line"></div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">         <span class="keyword">let</span> timeout;</div><div class="line">         link.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">             link.onload = <span class="literal">null</span>;</div><div class="line">             link.onerror = <span class="literal">null</span>;</div><div class="line">             clearTimeout(timeout);</div><div class="line">             resolve(<span class="string">`css chunk loaded: <span class="subst">$&#123;chunkName&#125;</span>`</span>);</div><div class="line">         &#125;;</div><div class="line">         link.onerror = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">             link.onload = <span class="literal">null</span>;</div><div class="line">             link.onerror = <span class="literal">null</span>;</div><div class="line">             clearTimeout(timeout);</div><div class="line">             reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`could not load css chunk: <span class="subst">$&#123;chunkName&#125;</span>`</span>));</div><div class="line">         &#125;;</div><div class="line">         timeout = setTimeout(link.onerror, <span class="number">30000</span>);</div><div class="line">         head.appendChild(link);</div><div class="line">     &#125;);</div><div class="line"> &#125;;</div></pre></td></tr></table></figure>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// routes.js</span></div><div class="line"></div><div class="line"> &lt;IndexRoute</div><div class="line">     name=<span class="string">"landing"</span></div><div class="line">     getComponent=&#123;<span class="function">(<span class="params">_, cb</span>) =&gt;</span> &#123;</div><div class="line">         <span class="built_in">Promise</span>.all([</div><div class="line">             <span class="keyword">import</span>(<span class="string">'./views/LandingPage/LandingPage'</span> <span class="comment">/* webpackChunkName: 'landing' */</span>),</div><div class="line">             importCss(<span class="string">'landing'</span>),</div><div class="line">         ]).then(<span class="function">(<span class="params">[<span class="built_in">module</span>]</span>) =&gt;</span> cb(<span class="literal">null</span>, <span class="built_in">module</span>.<span class="keyword">default</span>));</div><div class="line">     &#125;&#125;</div><div class="line"> /&gt;</div><div class="line"> &lt;Route</div><div class="line">     name=<span class="string">"search"</span></div><div class="line">     path=<span class="string">"/search/"</span></div><div class="line">     getComponent=&#123;<span class="function">(<span class="params">_, cb</span>) =&gt;</span> &#123;</div><div class="line">         <span class="built_in">Promise</span>.all([</div><div class="line">             <span class="keyword">import</span>(<span class="string">'./views/SearchResultsPage/SearchResultsPage'</span> <span class="comment">/* webpackChunkName: 'search' */</span>),</div><div class="line">             importCss(<span class="string">'search'</span>),</div><div class="line">         ]).then(<span class="function">(<span class="params">[<span class="built_in">module</span>]</span>) =&gt;</span> cb(<span class="literal">null</span>, <span class="built_in">module</span>.<span class="keyword">default</span>));</div><div class="line">     &#125;&#125;</div><div class="line"> /&gt;</div></pre></td></tr></table></figure>
<p>通过这种新方法，路由跳转会进行两个并行的异步请求，一个给JS，另一个给CSS，而不像之前所有的CSS都在DOMContentLoaded时被加载。对于用户只会下载当前访问页面所需的CSS来说，这样更可行。</p>
<p><strong>A/B 测试</strong></p>
<p>Treebo目前正在实施AB测试方法，包含服务器端渲染和代码分割，以便在服务器端和客户端渲染期间拉下用户所需要的版本。 （Treebo将发布一篇关于他们如何解决这个问题的博文）。</p>
<p><strong>预加载</strong></p>
<p>理想中，为了避免对关键资源下载的流量争用，Treebo不希望在页面初始加载所有应用分割的模块，对于移动端用户，在下次访问时，如果没使用service-worker来缓存，也确实浪费宝贵的流量。如果我们看看Treebo在持续交互方面做的怎样，仍然有许多空间可以改善：</p>
<p><img src="http://p0.qhimg.com/t01bb9591d9a250e06b.png" alt=""></p>
<p>这是他们正在尝试改进的领域。 一个例子是在按钮的波纹动画期间预加载下一个路由模块。 点击时， Treebo使用webpack<a href="https://webpack.js.org/guides/code-splitting/#dynamic-imports" target="_blank" rel="external">动态import（）</a>回调来加载下一个路由模块，并用setTimeout延迟路由跳转。 他们还希望确保下一个路由模块足够小，以便在缓慢的3g网络上给定的400ms之内能加载完。</p>
<h2 id="4-完结"><a href="#4-完结" class="headerlink" title="4. 完结"></a>4. 完结</h2><p>合作写这篇文章很愉快。虽然还有很多工作需要做，但我们衷心希望你能享受阅读这篇Treebo的性能之旅:)可以在twitter上找到我俩<a href="https://medium.com/@addyosmani" title="Medium profile for @addyosmani" target="_blank" rel="external">@addyosmani</a>和<a href="https://medium.com/@__lakshya" title="Medium profile for @__lakshya" target="_blank" rel="external">@__lakshya</a>(是的，两个短下划线)我们希望听到你的想法。</p>
<p>感谢 <a href="https://twitter.com/@_zouhir" target="_blank" rel="external">_@<em>zouhir</em></a>, <a href="https://twitter.com/@_developit" target="_blank" rel="external">_@<em>developit</em></a> 和 <a href="https://twitter.com/@samccone" target="_blank" rel="external"><em>@samcccone</em></a><br>的校对和提议。</p>
<p>如果你是刚接触React，Wes Bos 写的<a href="https://goo.gl/G1WGxU" target="_blank" rel="external">React for Beginners</a>对于入门React是一篇全面的文章。</p>
<p>感谢<a href="https://medium.com/@developit?source=post_page" target="_blank" rel="external">Jason Miller</a>和<a href="https://medium.com/@__lakshya?source=post_page" target="_blank" rel="external">Lakshya Ranganath</a>.</p>
</div><div class="tags"><a href="/tags/React/">React</a><a href="/tags/PWA/">PWA</a></div><div class="post-nav"><a href="/2017/09/09/下划线是否破坏可读性？-UX-Booth/" class="next">下划线是否破坏可读性？ | UX Booth [译文]</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="ejayyoung.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/翻译/">翻译</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/Reflux/" style="font-size: 15px;">Reflux</a> <a href="/tags/PWA/" style="font-size: 15px;">PWA</a> <a href="/tags/UX/" style="font-size: 15px;">UX</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/01/一份来自Treebo-的-React-与-Preact-PWA-性能分析报告/">一份来自Treebo 的 React 与 Preact PWA 性能分析报告</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/09/下划线是否破坏可读性？-UX-Booth/">下划线是否破坏可读性？ | UX Booth [译文]</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/18/reflux-startup/">Reflux 入门 TodoList</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/18/Page-Visibility-API/">Page Visibility API</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">雪庐.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>